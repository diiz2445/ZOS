# ZOS

1. **Драйверы в Unix/Linux**:
   - **Определение**: Программы, обеспечивающие взаимодействие ОС с аппаратным обеспечением, действуя как посредники.
   - **Необходимость**: Управление устройствами, обеспечение совместимости, поддержка новых устройств, абстракция оборудования для приложений.
   - **Виды по загрузке**:
     - **Встроенные**: Компилируются в ядро, используются для критических устройств (диски, файловые системы).
     - **Модульные**: Динамически загружаемые модули (.ko), гибкие, подгружаются через udev.
   - **Виды по типу устройств**:
     - **Блочные**: Для хранения данных (диски, SSD, USB).
     - **Символьные**: Потоковые данные (клавиатуры, порты, /dev/null).
     - **Сетевые**: Для сетевых интерфейсов (Ethernet, Wi-Fi).
   - **Группы по функционалу**: Графические, сетевые, звуковые, USB, хранилища, шинные, ввода.
   - **Группы по уровню**:
     - **Ядерные**: Высокие привилегии, прямой доступ к оборудованию.
     - **Пользовательские**: Безопаснее, работают через системные вызовы.
   - **Расположение**: В `/lib/modules/<версия_ядра>/kernel/drivers/` (подкаталоги: net, block, char, usb, gpu и др.), файлы с расширением .ko, плюс служебные файлы (modules.dep, modules.alias).

2. **Структура драйвера**:
   - **Архитектура**: Разделение на пользовательский (User Space, /dev) и ядерный (Kernel Space) уровни.
   - **Компоненты**:
     - Функции инициализации/выгрузки (`module_init`, `module_exit`).
     - Регистрация устройства (символьное/блочное).
     - Обработка системных вызовов (open, read, write, release).
     - Создание узла в `/dev` (mknod или udev).
     - Обработка прерываний (`request_irq`).
     - Взаимодействие с пользователем через файловый интерфейс.
   - **Ключевые структуры ядра**:
     - `file_operations`: Определяет функции для вызовов.
     - `inode`: Метаинформация о файле-устройстве.
     - `file`: Состояние открытого устройства.
     - `cdev`: Для символьных устройств.
     - `device/class`: Интеграция с sysfs/udev.
   - **Принцип работы**: Пользовательские вызовы перенаправляются драйверу через /dev, драйвер взаимодействует с оборудованием.

3. **Коммутаторы**:
   - **Роль**: Обеспечивают коммутацию пакетов в сетях, управляются драйверами для интеграции с ОС и сетевым стеком.
   - **Протоколы управления**: Основной — **SNMP** (Simple Network Management Protocol):
     - Работает через UDP (порты 161, 162).
     - Компоненты: менеджер (Zabbix, Prometheus), агент (snmpd), MIB (база OID).
     - Версии: SNMPv1 (простая), SNMPv2c (bulk-запросы), SNMPv3 (шифрование, аутентификация).
   - **Реализация в Linux**:
     - Пакет `net-snmp` (snmpd, snmpwalk, snmpget, snmpset, snmptrapd).
     - Конфигурация: `/etc/snmp/snmpd.conf`.
     - Команды: `snmpget`, `snmpwalk`, `snmpset` для мониторинга/настройки.
   - **Функции**: Мониторинг (загрузка, ошибки, температура), настройка (порты, VLAN, QoS), уведомления (traps).
   - **Интеграция**: Системы Zabbix, Prometheus, LibreNMS; работа с MIB (/usr/share/snmp/mibs).
   - **Альтернативы**: NetConf/YANG, gRPC Telemetry, RESTCONF.

4. **Различия видов драйверов**:
   - **Устройственные**:
     - **Блочные**: Для хранения (диски, SSD), используют буферизацию, кэширование, интегрированы с block layer.
     - **Символьные**: Потоковые данные без буферизации (клавиатуры, /dev/tty, /dev/null), прямой ввод-вывод.
     - **Сетевые**: Управляют интерфейсами (Ethernet, Wi-Fi), работают с netdev, sk_buff, TCP/IP.
   - **Виртуальные**: Эмулируют устройства (tun/tap, virtio_blk), для VPN, виртуализации.
   - **Псевдоустройства**: Системные ресурсы (/dev/null, /dev/zero, /dev/random), обычно символьные.
   - **Модульные (LKM)**: Динамическая загрузка (`modprobe`), гибкость, для USB, Wi-Fi.
   - **Монолитные**: Встроены в ядро, высокая производительность, для критических устройств (ext4, SCSI).
   - **Подсистемы**:
     - Linux: ALSA (звук), V4L2 (видео).
     - BSD: devfs (автосоздание /dev).
     - Solaris: STREAMS (модульные потоки).
   - **Проблемы**: Совместимость оборудования, несовместимость с новыми ядрами, проприетарные драйверы.

5. **Пример работы драйвера**:
   - **Тип**: Символьный драйвер (простота, не требует оборудования).
   - **Этапы**:
     - **Создание модуля**: Код на C, макросы `module_init`, `module_exit`, структура `file_operations`, регистрация устройства.
     - **Компиляция**: Makefile, создание файла .ko.
     - **Загрузка**: `insmod` (прямая) или `modprobe` (с зависимостями).
     - **Создание узла**: `mknod` для файла в `/dev` (major/minor номера).
     - **Тестирование**: Использование `cat` (чтение), `echo` (запись), проверка логов (`dmesg`).
   - **Пример функционала**: Драйвер хранит данные в буфере, возвращает их при чтении, принимает новые при записи.

